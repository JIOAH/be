<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Generator Daftar Pustaka - Fields Opsional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
            gap: 25px;
        }
        
        .input-section {
            flex: 1;
            min-width: 350px;
            padding: 25px;
            background-color: #f9fafc;
            border-radius: 12px;
        }
        
        .output-section {
            flex: 1;
            min-width: 350px;
            padding: 25px;
            background-color: #f9fafc;
            border-radius: 12px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .optional {
            color: #6c757d;
            font-weight: normal;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4a6491;
            box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.15);
        }
        
        .btn {
            padding: 14px 25px;
            background: linear-gradient(135deg, #4a6491, #3a5479);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 100, 145, 0.25);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        /* STYLING UNTUK OUTPUT BOX - DIPERBARUI */
        .output-box {
            background-color: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 25px;
            min-height: 350px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-top: 15px;
            font-size: 0.95rem;
        }
        
        /* Class untuk pemformatan paragraf */
        .formatted-output {
            line-height: 0.9 !important;
            font-family: 'Times New Roman', serif !important;
        }
        
        /* Indentasi gantung (hanging indent) */
        .hanging-indent {
            padding-left: 2em !important;
            text-indent: -2em !important;
        }
        
        /* Indentasi baris pertama */
        .first-line-indent {
            text-indent: 2em !important;
        }
        
        /* Tanpa indentasi */
        .no-indent {
            text-indent: 0 !important;
            padding-left: 0 !important;
        }
        
        /* Spasi antar referensi */
        .reference-spacing {
            margin-bottom: 1.2em !important;
        }
        
        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .format-card {
            padding: 15px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .format-card:hover {
            border-color: #4a6491;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .format-card.selected {
            background: #4a6491;
            color: white;
            border-color: #4a6491;
            box-shadow: 0 4px 12px rgba(74, 100, 145, 0.3);
        }
        
        .format-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        .format-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .reference-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4a6491;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            background: #4a6491;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
        
        .field-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .required-star {
            color: #dc3545;
        }
        
        .optional-badge {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a6491;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        /* Panel kontrol pemformatan */
        .formatting-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .formatting-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .formatting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .formatting-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .formatting-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .formatting-input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 80px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            font-size: 0.85rem;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Generator Daftar Pustaka</h1>
            <p class="subtitle">Fields Opsional - Tidak Perlu Diisi Semua</p>
        </header>
        
        <div class="main-content">
            <!-- INPUT SECTION -->
            <div class="input-section">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">üìù Input Data Referensi</h2>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="refCount">0</div>
                        <div class="stat-label">Referensi</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completeCount">0</div>
                        <div class="stat-label">Lengkap</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="refType">Jenis Referensi</label>
                    <select id="refType" onchange="toggleFields()">
                        <option value="journal">üìÑ Jurnal Artikel</option>
                        <option value="book">üìö Buku</option>
                        <option value="website">üåê Situs Web</option>
                        <option value="conference">üë• Konferensi</option>
                        <option value="thesis">üéì Tesis/Disertasi</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="author">
                        Penulis <span class="required-star">*</span>
                        <span class="optional-badge">Wajib</span>
                    </label>
                    <input type="text" id="author" placeholder="Contoh: Smith, J. A.">
                    <div class="field-info">Jika tidak tahu penulis, tulis: Anonim</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="year">
                            Tahun <span class="required-star">*</span>
                            <span class="optional-badge">Wajib</span>
                        </label>
                        <input type="number" id="year" placeholder="2024" min="1900" max="2100">
                    </div>
                    <div class="form-group">
                        <label for="edition" class="optional">Edisi <span class="optional-badge">Opsional</span></label>
                        <input type="text" id="edition" placeholder="Edisi ke-">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="title">
                        Judul <span class="required-star">*</span>
                        <span class="optional-badge">Wajib</span>
                    </label>
                    <input type="text" id="title" placeholder="Judul referensi...">
                </div>
                
                <div id="journalFields" style="display: block;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="journalTitle" class="optional">Nama Jurnal <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="journalTitle" placeholder="Nama jurnal">
                        </div>
                        <div class="form-group">
                            <label for="volume" class="optional">Volume <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="volume" placeholder="Vol.">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="issue" class="optional">Issue/Nomor <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="issue" placeholder="No.">
                        </div>
                        <div class="form-group">
                            <label for="doi" class="optional">DOI <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="doi" placeholder="10.xxxx/xxxx">
                        </div>
                    </div>
                </div>
                
                <div id="bookFields" style="display: none;">
                    <div class="form-group">
                        <label for="publisher" class="optional">Penerbit <span class="optional-badge">Opsional</span></label>
                        <input type="text" id="publisher">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city" class="optional">Kota Terbit <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="city">
                        </div>
                        <div class="form-group">
                            <label for="country" class="optional">Negara <span class="optional-badge">Opsional</span></label>
                            <input type="text" id="country">
                        </div>
                    </div>
                </div>
                
                <div id="webFields" style="display: none;">
                    <div class="form-group">
                        <label for="url" class="optional">URL <span class="optional-badge">Opsional</span></label>
                        <input type="url" id="url" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="accessDate" class="optional">Tanggal Akses <span class="optional-badge">Opsional</span></label>
                        <input type="date" id="accessDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pageInfo" class="optional">Informasi Halaman <span class="optional-badge">Opsional</span></label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="number" id="totalPages" placeholder="Jml halaman total">
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="startPage" placeholder="Dari" style="width: 80px;">
                                <span>-</span>
                                <input type="number" id="endPage" placeholder="Sampai" style="width: 80px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" onclick="addReference()">
                        + Tambahkan Referensi
                    </button>
                    <button class="btn btn-secondary" onclick="clearForm()">
                        üîÑ Reset Form
                    </button>
                    <button class="btn" onclick="fillMinimal()">
                        üìù Minimal Input
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e8f4fc; border-radius: 8px;">
                    <strong>üìå Informasi:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; font-size: 0.9rem;">
                        <li>Hanya <strong>3 field wajib</strong>: Penulis, Tahun, Judul</li>
                        <li>Field lainnya <strong>opsional</strong> - bisa dikosongkan</li>
                        <li>Output akan otomatis menyesuaikan data yang ada</li>
                        <li>Tidak ada tag HTML dalam output</li>
                        <li><strong>Tidak ada penomoran otomatis</strong> - hanya format referensi murni</li>
                    </ul>
                </div>
            </div>
            
            <!-- OUTPUT SECTION -->
            <div class="output-section">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">üìã Format Output</h2>
                
                <!-- Kontrol Pemformatan -->
                <div class="formatting-controls">
                    <h3 style="font-size: 1rem; margin-bottom: 10px; color: #2c3e50;">üé® Pemformatan Paragraf</h3>
                    <div class="formatting-row">
                        <div class="formatting-group">
                            <label class="formatting-label">Jenis Indentasi:</label>
                            <select class="formatting-select" id="indentType" onchange="updateFormatting()">
                                <option value="hanging">Indentasi Gantung</option>
                                <option value="first-line">Indentasi Baris Pertama</option>
                                <option value="none">Tanpa Indentasi</option>
                            </select>
                        </div>
                        
                        <div class="formatting-group">
                            <label class="formatting-label">Spasi Baris:</label>
                            <input type="number" class="formatting-input" id="lineSpacing" 
                                   min="0.5" max="2" step="0.1" value="0.9" onchange="updateFormatting()">
                        </div>
                        
                        <div class="formatting-group">
                            <label class="formatting-label">Spasi Antar Referensi:</label>
                            <input type="number" class="formatting-input" id="refSpacing" 
                                   min="0" max="3" step="0.1" value="1.2" onchange="updateFormatting()">
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="boldNumbers" onchange="updateFormatting()">
                            <label for="boldNumbers">Angka tebal</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="italicTitles" onchange="updateFormatting()">
                            <label for="italicTitles">Judul miring</label>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('basic')">Basic</button>
                    <button class="tab" onclick="showTab('academic')">Academic</button>
                    <button class="tab" onclick="showTab('simple')">Simple</button>
                </div>
                
                <!-- Basic Formats -->
                <div id="basic" class="tab-content active">
                    <div class="format-grid">
                        <div class="format-card" onclick="selectFormat('apa')">
                            <div class="format-name">APA</div>
                            <div class="format-desc">Author (Year). Title.</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('mla')">
                            <div class="format-name">MLA</div>
                            <div class="format-desc">Author. "Title."</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('chicago')">
                            <div class="format-name">Chicago</div>
                            <div class="format-desc">Author. Year. "Title."</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('harvard')">
                            <div class="format-name">Harvard</div>
                            <div class="format-desc">Author (Year) Title</div>
                        </div>
                    </div>
                </div>
                
                <!-- Academic Formats -->
                <div id="academic" class="tab-content">
                    <div class="format-grid">
                        <div class="format-card" onclick="selectFormat('ieee')">
                            <div class="format-name">IEEE</div>
                            <div class="format-desc">A. Author, "Title"</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('vancouver')">
                            <div class="format-name">Vancouver</div>
                            <div class="format-desc">Author. Title.</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('nature')">
                            <div class="format-name">Nature</div>
                            <div class="format-desc">Author. Title. Journal Year</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('science')">
                            <div class="format-name">Science</div>
                            <div class="format-desc">Author, Title. Journal Year</div>
                        </div>
                    </div>
                </div>
                
                <!-- Simple Formats -->
                <div id="simple" class="tab-content">
                    <div class="format-grid">
                        <div class="format-card" onclick="selectFormat('simple')">
                            <div class="format-name">Simple</div>
                            <div class="format-desc">Author. Title. Year.</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('numbered')">
                            <div class="format-name">Numbered</div>
                            <div class="format-desc">(Dengan angka)</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('compact')">
                            <div class="format-name">Compact</div>
                            <div class="format-desc">Author (Year) Title</div>
                        </div>
                        <div class="format-card" onclick="selectFormat('custom')">
                            <div class="format-name">Custom</div>
                            <div class="format-desc">Pilih elemen sendiri</div>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Format Info -->
                <div style="margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 8px;">
                    <strong>Format Terpilih:</strong>
                    <div id="formatInfo" style="margin-top: 10px;">
                        <span id="selectedFormat" style="font-weight: bold; color: #2c3e50;">APA Style</span>
                        <div id="formatDescription" style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            <span id="currentFormattingInfo">Indentasi gantung, spasi 0.9</span>
                        </div>
                    </div>
                </div>
                
                <!-- Output Box -->
                <div style="margin-top: 20px;">
                    <label>Hasil Daftar Pustaka:</label>
                    <div class="output-box" id="output">
                        Tambahkan referensi dengan minimal 3 data wajib...
                        Field opsional bisa dikosongkan.
                        Output TANPA penomoran otomatis.
                    </div>
                </div>
                
                <!-- Output Actions -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="generateBibliography()">
                        üîß Generate
                    </button>
                    <button class="btn" onclick="copyToClipboard()">
                        üìã Copy
                    </button>
                    <button class="btn" onclick="downloadAsTxt()">
                        üì• Download
                    </button>
                    <button class="btn btn-danger" onclick="clearAll()">
                        üóëÔ∏è Clear All
                    </button>
                </div>
                
                <!-- References List -->
                <div style="margin-top: 20px;">
                    <label>Daftar Referensi (<span id="refCount2">0</span>):</label>
                    <div id="referencesList" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                        <!-- Dynamic content -->
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px;">
                    <strong>‚úÖ Fleksibel:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; font-size: 0.9rem;">
                        <li>Input bisa <strong>minimal</strong> (hanya 3 field wajib)</li>
                        <li>Field kosong akan <strong>dihiraukan</strong> dalam output</li>
                        <li>Format otomatis <strong>menyesuaikan</strong> data yang ada</li>
                        <li><strong>TANPA penomoran</strong> - hanya referensi murni</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== STATE MANAGEMENT =====
        let references = JSON.parse(localStorage.getItem('bibliography_references')) || [];
        let selectedFormat = 'apa';
        
        // ===== PENGATURAN PEMFORMATAN =====
        let formattingSettings = {
            indentType: 'hanging',
            lineSpacing: 0.9,
            refSpacing: 1.2,
            boldNumbers: true,
            italicTitles: true
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            updateReferencesList();
            
            // Add example data if empty
            if (references.length === 0) {
                addExampleReferences();
            }
            
            // Initialize format
            selectFormat('apa');
            
            // Load formatting settings from localStorage
            const savedSettings = localStorage.getItem('bibliography_formatting');
            if (savedSettings) {
                formattingSettings = JSON.parse(savedSettings);
                applyFormattingSettings();
            }
        });
        
        // ===== UI FUNCTIONS =====
        function showTab(tabId) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        function selectFormat(format) {
            selectedFormat = format;
            
            // Update UI
            document.querySelectorAll('.format-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Find and select the clicked card
            const cards = document.querySelectorAll('.format-card');
            for (let card of cards) {
                if (card.querySelector('.format-name').textContent.toLowerCase().includes(format)) {
                    card.classList.add('selected');
                    break;
                }
            }
            
            // Update format info
            const formatNames = {
                'apa': 'APA Style',
                'mla': 'MLA Style', 
                'chicago': 'Chicago Style',
                'harvard': 'Harvard Style',
                'ieee': 'IEEE Style',
                'vancouver': 'Vancouver Style',
                'nature': 'Nature Style',
                'science': 'Science Style',
                'simple': 'Simple Format',
                'numbered': 'Numbered List',
                'compact': 'Compact Format',
                'custom': 'Custom Format'
            };
            
            document.getElementById('selectedFormat').textContent = formatNames[format] || format;
        }
        
        function toggleFields() {
            const type = document.getElementById('refType').value;
            
            // Hide all
            document.getElementById('journalFields').style.display = 'none';
            document.getElementById('bookFields').style.display = 'none';
            document.getElementById('webFields').style.display = 'none';
            
            // Show relevant fields
            if (type === 'journal' || type === 'conference') {
                document.getElementById('journalFields').style.display = 'block';
            }
            if (type === 'book' || type === 'thesis') {
                document.getElementById('bookFields').style.display = 'block';
            }
            if (type === 'website') {
                document.getElementById('webFields').style.display = 'block';
            }
        }
        
        function fillMinimal() {
            // Fill only required fields
            document.getElementById('author').value = 'Smith, J. A.';
            document.getElementById('year').value = '2023';
            document.getElementById('title').value = 'Sample Article Title';
            
            showToast('‚úÖ Minimal input diisi (hanya field wajib)');
        }
        
        // ===== FUNGSI PEMFORMATAN =====
        function updateFormatting() {
            // Update settings from UI
            formattingSettings.indentType = document.getElementById('indentType').value;
            formattingSettings.lineSpacing = parseFloat(document.getElementById('lineSpacing').value);
            formattingSettings.refSpacing = parseFloat(document.getElementById('refSpacing').value);
            formattingSettings.boldNumbers = document.getElementById('boldNumbers').checked;
            formattingSettings.italicTitles = document.getElementById('italicTitles').checked;
            
            // Save to localStorage
            localStorage.setItem('bibliography_formatting', JSON.stringify(formattingSettings));
            
            // Update UI
            updateFormattingInfo();
            
            // Re-generate bibliography if already generated
            const output = document.getElementById('output').textContent;
            if (!output.includes('Tambahkan referensi')) {
                generateBibliography();
            }
        }
        
        function applyFormattingSettings() {
            // Apply settings to UI controls
            document.getElementById('indentType').value = formattingSettings.indentType;
            document.getElementById('lineSpacing').value = formattingSettings.lineSpacing;
            document.getElementById('refSpacing').value = formattingSettings.refSpacing;
            document.getElementById('boldNumbers').checked = formattingSettings.boldNumbers;
            document.getElementById('italicTitles').checked = formattingSettings.italicTitles;
            
            updateFormattingInfo();
        }
        
        function updateFormattingInfo() {
            const indentNames = {
                'hanging': 'Indentasi Gantung',
                'first-line': 'Indentasi Baris Pertama',
                'none': 'Tanpa Indentasi'
            };
            
            const info = `${indentNames[formattingSettings.indentType]}, spasi baris ${formattingSettings.lineSpacing}`;
            document.getElementById('currentFormattingInfo').textContent = info;
        }
        
        // ===== DATA MANAGEMENT =====
        function addReference() {
            // Get form values (trim whitespace)
            const refType = document.getElementById('refType').value;
            const author = document.getElementById('author').value.trim();
            const year = document.getElementById('year').value.trim();
            const title = document.getElementById('title').value.trim();
            const edition = document.getElementById('edition').value.trim();
            const journalTitle = document.getElementById('journalTitle').value.trim();
            const volume = document.getElementById('volume').value.trim();
            const issue = document.getElementById('issue').value.trim();
            const doi = document.getElementById('doi').value.trim();
            const publisher = document.getElementById('publisher').value.trim();
            const city = document.getElementById('city').value.trim();
            const country = document.getElementById('country').value.trim();
            const totalPages = document.getElementById('totalPages').value.trim();
            const startPage = document.getElementById('startPage').value.trim();
            const endPage = document.getElementById('endPage').value.trim();
            const url = document.getElementById('url').value.trim();
            const accessDate = document.getElementById('accessDate').value;
            
            // Validation - ONLY 3 FIELDS ARE REQUIRED
            if (!author || !year || !title) {
                showToast('‚ùå Mohon isi Penulis, Tahun, dan Judul', 'error');
                return;
            }
            
            // Create reference object with only filled fields
            const reference = {
                id: Date.now(),
                type: refType,
                author: author || 'Anonim',
                year: year || 'n.d.',
                title: title || 'Tidak ada judul',
                createdAt: new Date().toISOString()
            };
            
            // Add optional fields only if they have value
            if (edition) reference.edition = edition;
            if (journalTitle) reference.journalTitle = journalTitle;
            if (volume) reference.volume = volume;
            if (issue) reference.issue = issue;
            if (doi) reference.doi = doi;
            if (publisher) reference.publisher = publisher;
            if (city) reference.city = city;
            if (country) reference.country = country;
            if (totalPages) reference.totalPages = totalPages;
            if (startPage) reference.startPage = startPage;
            if (endPage) reference.endPage = endPage;
            if (url) reference.url = url;
            if (accessDate) reference.accessDate = accessDate;
            
            // Add to references
            references.push(reference);
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Update UI
            clearForm();
            updateReferencesList();
            updateStats();
            
            showToast('‚úÖ Referensi berhasil ditambahkan');
        }
        
        function clearForm() {
            // Clear all fields
            document.getElementById('author').value = '';
            document.getElementById('year').value = '';
            document.getElementById('title').value = '';
            document.getElementById('edition').value = '';
            document.getElementById('journalTitle').value = '';
            document.getElementById('volume').value = '';
            document.getElementById('issue').value = '';
            document.getElementById('doi').value = '';
            document.getElementById('publisher').value = '';
            document.getElementById('city').value = '';
            document.getElementById('country').value = '';
            document.getElementById('totalPages').value = '';
            document.getElementById('startPage').value = '';
            document.getElementById('endPage').value = '';
            document.getElementById('url').value = '';
            document.getElementById('accessDate').value = '';
        }
        
        function removeReference(id) {
            if (confirm('Hapus referensi ini?')) {
                references = references.filter(ref => ref.id !== id);
                saveToLocalStorage();
                updateReferencesList();
                updateStats();
                showToast('üóëÔ∏è Referensi dihapus');
            }
        }
        
        function clearAll() {
            if (references.length === 0) {
                showToast('Tidak ada referensi untuk dihapus');
                return;
            }
            
            if (confirm(`Hapus semua ${references.length} referensi?`)) {
                references = [];
                saveToLocalStorage();
                updateReferencesList();
                updateStats();
                document.getElementById('output').textContent = 'Tambahkan referensi dengan minimal 3 data wajib...\nField opsional bisa dikosongkan.\nOutput TANPA penomoran otomatis.';
                showToast('üßπ Semua referensi dihapus');
            }
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('bibliography_references', JSON.stringify(references));
        }
        
        // ===== UI UPDATES =====
        function updateReferencesList() {
            const container = document.getElementById('referencesList');
            const count = references.length;
            document.getElementById('refCount2').textContent = count;
            
            if (count === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Belum ada referensi...</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            references.forEach((ref, index) => {
                const typeIcon = ref.type === 'journal' ? 'üìÑ' : 
                                ref.type === 'book' ? 'üìö' : 
                                ref.type === 'website' ? 'üåê' : 'üìù';
                
                // Calculate completeness
                const filledFields = Object.keys(ref).length - 4; // minus id, type, createdAt
                const completeness = Math.min(100, (filledFields / 10) * 100);
                
                html += `
                    <div class="reference-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="font-size: 0.9rem;">${typeIcon} ${ref.author} (${ref.year})</strong><br>
                                <span style="font-size: 0.85rem; color: #666;">${ref.title.substring(0, 50)}${ref.title.length > 50 ? '...' : ''}</span><br>
                                <small style="color: #28a745;">${Math.round(completeness)}% lengkap</small>
                            </div>
                            <button onclick="removeReference(${ref.id})" 
                                    style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateStats() {
            const count = references.length;
            document.getElementById('refCount').textContent = count;
            
            // Calculate complete references (has more than just required fields)
            let completeCount = 0;
            references.forEach(ref => {
                const filledFields = Object.keys(ref).length;
                if (filledFields > 6) { // More than id, type, author, year, title, createdAt
                    completeCount++;
                }
            });
            document.getElementById('completeCount').textContent = completeCount;
        }
        
        // ===== BIBLIOGRAPHY GENERATION (TANPA PENOMORAN) =====
        function generateBibliography() {
            if (references.length === 0) {
                showToast('‚ùå Tambahkan referensi terlebih dahulu', 'error');
                return;
            }
            
            // Sort references alphabetically
            references.sort((a, b) => {
                const authorA = a.author.toLowerCase().split(',')[0];
                const authorB = b.author.toLowerCase().split(',')[0];
                return authorA.localeCompare(authorB);
            });
            
            // Generate bibliography based on selected format
            let bibliography = '';
            
            switch(selectedFormat) {
                case 'apa':
                    bibliography = generateAPA();
                    break;
                case 'mla':
                    bibliography = generateMLA();
                    break;
                case 'chicago':
                    bibliography = generateChicago();
                    break;
                case 'harvard':
                    bibliography = generateHarvard();
                    break;
                case 'ieee':
                    bibliography = generateIEEE();
                    break;
                case 'vancouver':
                    bibliography = generateVancouver();
                    break;
                case 'nature':
                    bibliography = generateNature();
                    break;
                case 'science':
                    bibliography = generateScience();
                    break;
                case 'simple':
                    bibliography = generateSimple();
                    break;
                case 'numbered':
                    bibliography = generateNumbered();
                    break;
                case 'compact':
                    bibliography = generateCompact();
                    break;
                case 'custom':
                    bibliography = generateCustom();
                    break;
                default:
                    bibliography = generateAPA();
            }
            
            // Apply formatting
            bibliography = applyFormatting(bibliography);
            
            // Update output
            document.getElementById('output').innerHTML = bibliography;
            
            // Update formatting info
            updateFormattingInfo();
            
            showToast(`‚úÖ ${selectedFormat.toUpperCase()} berhasil dibuat`);
        }
        
        function applyFormatting(text) {
            // Split by lines
            const lines = text.split('\n');
            let formattedHTML = '';
            
            // Apply line spacing
            const lineSpacingStyle = `line-height: ${formattingSettings.lineSpacing} !important;`;
            
            // Apply spacing between references
            const refSpacingStyle = `margin-bottom: ${formattingSettings.refSpacing}em !important;`;
            
            // Get indent class
            const indentClass = `${formattingSettings.indentType}-indent`;
            
            lines.forEach((line, index) => {
                if (line.trim() === '') {
                    // Empty line - keep it as is
                    formattedHTML += '<br>';
                } else if (line.includes('REFERENCES') || line.includes('WORKS CITED') || line.includes('REFERENSI')) {
                    // Header
                    formattedHTML += `<div style="font-weight: bold; font-size: 1.1em; margin-bottom: 1em;">${line}</div>`;
                } else {
                    // Regular text - TANPA penomoran
                    formattedHTML += `<div class="${indentClass}" style="${lineSpacingStyle} ${refSpacingStyle}">${processContent(line)}</div>`;
                }
            });
            
            return formattedHTML;
        }
        
        function processContent(text) {
            // Apply italic to titles if enabled
            if (formattingSettings.italicTitles) {
                // Look for titles in quotes or patterns
                text = text.replace(/"([^"]+)"/g, '"<em>$1</em>"');
                text = text.replace(/‚Äò([^']+)‚Äô/g, '‚Äò<em>$1</em>‚Äô');
                
                // For APA style: Title.
                if (selectedFormat === 'apa' || selectedFormat === 'chicago') {
                    text = text.replace(/([A-Z][^.]+\.)(?= )/g, '<em>$1</em>');
                }
            }
            
            return text;
        }
        
        // ===== FLEXIBLE FORMAT GENERATORS (TANPA PENOMORAN) =====
        
        // APA Style - TANPA nomor
        function generateAPA() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                // Basic structure with available data
                if (ref.author && ref.year && ref.title) {
                    entry = `${ref.author} (${ref.year}). ${ref.title}.`;
                    
                    // Add journal info if available
                    if (ref.journalTitle) {
                        entry += ` ${ref.journalTitle}`;
                        if (ref.volume) entry += `, ${ref.volume}`;
                        if (ref.issue) entry += `(${ref.issue})`;
                        if (ref.startPage && ref.endPage) entry += `, ${ref.startPage}-${ref.endPage}.`;
                        if (ref.doi) entry += ` https://doi.org/${ref.doi}`;
                    } 
                    // Add book info if available
                    else if (ref.publisher) {
                        if (ref.edition) entry += ` (${ref.edition}).`;
                        entry += ` ${ref.publisher}.`;
                        if (ref.totalPages) entry += ` (${ref.totalPages} hlm.)`;
                    }
                    // Add website info if available
                    else if (ref.url) {
                        entry += ` Retrieved from ${ref.url}`;
                        if (ref.accessDate) entry += ` on ${formatDate(ref.accessDate)}`;
                    }
                    // Minimal entry
                    else {
                        entry += ` (No publisher information).`;
                    }
                } else {
                    entry = `[Data tidak lengkap]`;
                }
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // MLA Style - TANPA nomor
        function generateMLA() {
            let bib = 'WORKS CITED\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author && ref.title) {
                    entry = `${ref.author}. "${ref.title}."`;
                    
                    // Add journal info
                    if (ref.journalTitle) {
                        entry += ` ${ref.journalTitle}`;
                        if (ref.volume) entry += `, vol. ${ref.volume}`;
                        if (ref.issue) entry += `, no. ${ref.issue}`;
                        if (ref.year) entry += `, ${ref.year}`;
                        if (ref.startPage && ref.endPage) entry += `, pp. ${ref.startPage}-${ref.endPage}.`;
                        if (ref.doi) entry += ` doi:${ref.doi}`;
                    }
                    // Add book info
                    else if (ref.publisher) {
                        if (ref.edition) entry += ` ${ref.edition},`;
                        if (ref.year) entry += ` ${ref.publisher}, ${ref.year}.`;
                        else entry += ` ${ref.publisher}.`;
                    }
                    // Add website info
                    else if (ref.url) {
                        entry += ` ${ref.url}`;
                        if (ref.accessDate) entry += `. Accessed ${formatDate(ref.accessDate)}.`;
                    }
                    // Minimal
                    else if (ref.year) {
                        entry += ` ${ref.year}.`;
                    } else {
                        entry += ` [No date].`;
                    }
                }
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // Simple Format - TANPA nomor
        function generateSimple() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                // Just author, title, year
                if (ref.author) entry += `${ref.author}. `;
                if (ref.title) entry += `${ref.title}. `;
                if (ref.year) entry += `(${ref.year}).`;
                
                // Add optional publisher if exists
                if (ref.publisher) entry += ` ${ref.publisher}.`;
                else if (ref.journalTitle) entry += ` ${ref.journalTitle}.`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // Numbered List - Dengan angka
        function generateNumbered() {
            let bib = '';
            
            references.forEach((ref, index) => {
                let entry = `${index + 1}. `;
                
                if (ref.author) entry += `${ref.author}. `;
                if (ref.title) entry += `${ref.title}. `;
                if (ref.year) entry += `(${ref.year})`;
                
                // Add optional info
                if (ref.publisher) entry += ` ${ref.publisher}.`;
                if (ref.doi) entry += ` DOI: ${ref.doi}`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // Compact Format - TANPA nomor
        function generateCompact() {
            let bib = '';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author) entry += `${ref.author} `;
                if (ref.year) entry += `(${ref.year}) `;
                if (ref.title) entry += `${ref.title}`;
                
                // Short optional info
                if (ref.journalTitle) entry += `. ${ref.journalTitle}`;
                else if (ref.publisher) entry += `. ${ref.publisher}`;
                
                if (ref.doi) entry += ` [${ref.doi}]`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // Custom Format - TANPA nomor
        function generateCustom() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                // Always include author if available
                if (ref.author) entry += `${ref.author}. `;
                
                // Include title
                if (ref.title) entry += `${ref.title}. `;
                
                // Include year if available
                if (ref.year) entry += `(${ref.year}) `;
                
                // Include journal/book info if available
                if (ref.journalTitle) {
                    entry += `In: ${ref.journalTitle}`;
                    if (ref.volume) entry += `, Vol. ${ref.volume}`;
                    if (ref.issue) entry += `(${ref.issue})`;
                    if (ref.startPage && ref.endPage) entry += `: ${ref.startPage}-${ref.endPage}`;
                    entry += `.`;
                } else if (ref.publisher) {
                    entry += `${ref.publisher}.`;
                    if (ref.city) entry += ` ${ref.city}.`;
                }
                
                // Include DOI if available
                if (ref.doi) entry += ` DOI: ${ref.doi}`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        // Other formats (simplified versions) - TANPA nomor
        function generateChicago() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author && ref.year && ref.title) {
                    entry = `${ref.author}. ${ref.year}. "${ref.title}."`;
                    
                    if (ref.journalTitle) {
                        entry += ` ${ref.journalTitle}`;
                        if (ref.volume) entry += ` ${ref.volume}`;
                        if (ref.issue) entry += `, no. ${ref.issue}`;
                        if (ref.startPage && ref.endPage) entry += `: ${ref.startPage}-${ref.endPage}.`;
                    } else if (ref.publisher) {
                        entry += ` ${ref.publisher}.`;
                    }
                }
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        function generateHarvard() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author && ref.year && ref.title) {
                    entry = `${ref.author} (${ref.year}) ${ref.title}.`;
                    
                    if (ref.journalTitle) {
                        entry += ` ${ref.journalTitle}`;
                        if (ref.volume) entry += `, ${ref.volume}`;
                        if (ref.issue) entry += `(${ref.issue})`;
                        if (ref.startPage && ref.endPage) entry += `, pp. ${ref.startPage}-${ref.endPage}.`;
                    } else if (ref.publisher) {
                        entry += ` ${ref.publisher}.`;
                    }
                }
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        function generateIEEE() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author) {
                    // Simple author formatting
                    const authors = ref.author.split(',')[0];
                    entry += `${authors}, `;
                }
                
                if (ref.title) entry += `"${ref.title}", `;
                
                if (ref.journalTitle) entry += `${ref.journalTitle}, `;
                else if (ref.publisher) entry += `${ref.publisher}, `;
                
                if (ref.year) entry += `${ref.year}.`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        function generateVancouver() {
            let bib = '';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author) entry += `${ref.author}. `;
                if (ref.title) entry += `${ref.title}. `;
                
                if (ref.journalTitle) {
                    entry += `${ref.journalTitle}. `;
                    if (ref.year) entry += `${ref.year};`;
                    if (ref.volume) entry += `${ref.volume}`;
                    if (ref.issue) entry += `(${ref.issue})`;
                    if (ref.startPage && ref.endPage) entry += `:${ref.startPage}-${ref.endPage}.`;
                } else if (ref.publisher) {
                    entry += `${ref.publisher}; `;
                    if (ref.year) entry += `${ref.year}.`;
                }
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        function generateNature() {
            let bib = 'REFERENCES\n\n';
            
            references.forEach((ref) => {
                let entry = '';
                
                if (ref.author) entry += `${ref.author}. `;
                if (ref.title) entry += `${ref.title}. `;
                if (ref.journalTitle) entry += `${ref.journalTitle} `;
                if (ref.year) entry += `${ref.year}`;
                if (ref.volume) entry += `, ${ref.volume}`;
                if (ref.startPage && ref.endPage) entry += `, ${ref.startPage}-${ref.endPage}`;
                if (ref.doi) entry += ` (${ref.doi}).`;
                
                bib += `${entry}\n\n`;
            });
            
            return bib;
        }
        
        function generateScience() {
            return generateNature();
        }
        
        // ===== HELPER FUNCTIONS =====
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        
        async function copyToClipboard() {
            const outputDiv = document.getElementById('output');
            const text = outputDiv.textContent;
            
            if (!text || text.includes('Tambahkan referensi')) {
                showToast('‚ùå Tidak ada teks untuk disalin', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showToast('‚úÖ Berhasil disalin ke clipboard');
            } catch (err) {
                console.error('Copy failed:', err);
                
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showToast('‚úÖ Berhasil disalin (fallback)');
            }
        }
        
        function downloadAsTxt() {
            const text = document.getElementById('output').textContent;
            
            if (!text || text.includes('Tambahkan referensi')) {
                showToast('‚ùå Tidak ada data untuk didownload', 'error');
                return;
            }
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `references-${selectedFormat}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('‚úÖ File berhasil didownload');
        }
        
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'error' ? '#dc3545' : '#28a745'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ===== EXAMPLE DATA =====
        function addExampleReferences() {
            const examples = [
                {
                    type: 'journal',
                    author: 'Smith, J. A.',
                    year: '2023',
                    title: 'Sample Research Article',
                    journalTitle: 'Journal of Examples',
                    volume: '15',
                    issue: '2',
                    startPage: '123',
                    endPage: '135',
                    doi: '10.1234/example.2023'
                },
                {
                    type: 'book',
                    author: 'Johnson, M. B.',
                    year: '2022',
                    title: 'Introduction to Research Methods',
                    publisher: 'Academic Press',
                    city: 'New York',
                    totalPages: '300'
                },
                {
                    type: 'website',
                    author: 'World Health Organization',
                    year: '2023',
                    title: 'Global Health Report',
                    url: 'https://www.who.int/reports'
                }
            ];
            
            examples.forEach(example => {
                references.push({
                    id: Date.now() + Math.random(),
                    ...example,
                    createdAt: new Date().toISOString()
                });
            });
            
            saveToLocalStorage();
            updateReferencesList();
            updateStats();
        }
        
        // Initialize toggle
        toggleFields();
        updateFormattingInfo();
    </script>
</body>
</html>
